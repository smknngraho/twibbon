<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twibbon Generator</title>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
  }
  #canvas-container {
    display: inline-block;
    background: #222;
    border: 2px solid #555;
  }
  input {
    margin: 10px 0;
  }
  button {
    background: #28a745;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover {
    background: #218838;
  }
</style>
</head>
<body>

<h2>Twibbon Generator</h2>

<input type="file" id="upload" accept="image/*"><br>
<div id="canvas-container">
  <canvas id="twibbonCanvas" width="400" height="500"></canvas>
</div><br>
<button id="downloadBtn">Download</button>

<!-- Fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script>
  const canvas = new fabric.Canvas('twibbonCanvas', {
    backgroundColor: '#000',
    preserveObjectStacking: true
  });

  let userImage = null;
  const overlayPath = 'twibbon1.png';

  // Load overlay
  fabric.Image.fromURL(overlayPath, function(img) {
    img.scaleToWidth(canvas.width);
    img.scaleToHeight(canvas.height);
    img.selectable = false;
    img.evented = false;
    img.set({ selectable: false });
    canvas.overlayImage = img;
    canvas.renderAll();
  });

  // Upload foto
  document.getElementById('upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(f) {
      fabric.Image.fromURL(f.target.result, function(img) {
        if (userImage) canvas.remove(userImage);

        img.set({
          left: canvas.width / 2,
          top: canvas.height / 2,
          originX: 'center',
          originY: 'center'
        });
        img.scaleToWidth(canvas.width);
        img.lockScalingFlip = true;

        userImage = img;
        canvas.add(userImage);
        canvas.sendToBack(userImage);
      });
    };
    reader.readAsDataURL(file);
  });

  // Download hasil 2500x3125
  document.getElementById('downloadBtn').addEventListener('click', function() {
    const exportCanvas = new fabric.Canvas(null, {
      width: 2500,
      height: 3125,
      backgroundColor: '#000',
      preserveObjectStacking: true
    });

    // Duplikat foto user
    if (userImage) {
      userImage.clone(function(clonedImg) {
        clonedImg.scaleToWidth(exportCanvas.width);
        clonedImg.set({
          left: exportCanvas.width / 2,
          top: exportCanvas.height / 2,
          originX: 'center',
          originY: 'center'
        });
        exportCanvas.add(clonedImg);
        exportCanvas.sendToBack(clonedImg);

        // Duplikat overlay
        fabric.Image.fromURL(overlayPath, function(overlayImg) {
          overlayImg.scaleToWidth(exportCanvas.width);
          overlayImg.scaleToHeight(exportCanvas.height);
          overlayImg.selectable = false;
          exportCanvas.add(overlayImg);
          exportCanvas.renderAll();

          const dataURL = exportCanvas.toDataURL({
            format: 'png',
            quality: 1.0
          });

          const link = document.createElement('a');
          link.href = dataURL;
          link.download = 'twibbon.png';
          link.click();
        });
      });
    }
  });
</script>

</body>
</html>
